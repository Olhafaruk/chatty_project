{% extends 'base.html' %}

{% block title %}{{ post.title|default:"(Ğ‘ĞµĞ· Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ°)" }}{% endblock %}

{% block content %}
<div class="container mt-5">
  <div class="mb-4">
    <h2>{{ post.title|default:"(Ğ‘ĞµĞ· Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ°)" }}</h2>
    <p class="text-muted">ĞĞ²Ñ‚Ğ¾Ñ€: {{ post.author.username }} â€¢ {{ post.created_at|date:"d.m.Y H:i" }}</p>
    <p>{{ post.content }}</p>

    <!-- Ğ‘Ğ»Ğ¾Ğº Ğ»Ğ°Ğ¹ĞºĞ¾Ğ² Ğ¸ Ğ´Ğ¸Ğ·Ğ»Ğ°Ğ¹ĞºĞ¾Ğ² -->
    <div class="d-flex gap-3 align-items-center mt-3">
      <button id="like-button" class="btn btn-outline-warning">
        <span id="like-icon">
          {% if user in post.likes.all %}
            ğŸ‘
          {% else %}
            <span style="color: white;">ğŸ‘</span>
          {% endif %}
        </span>
        <span id="like-count">{{ post.likes.count }}</span>
      </button>

      <button id="dislike-button" class="btn btn-outline-secondary">
        <span id="dislike-icon">
          {% if user in post.dislikes.all %}
            ğŸ‘
          {% else %}
            <span style="color: white;">ğŸ‘</span>
          {% endif %}
        </span>
        <span id="dislike-count">{{ post.dislikes.count }}</span>
      </button>
    </div>
  </div>

  <!-- ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¸ -->
  <div class="mt-5">
    <h5>ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¸</h5>
    {% for comment in post.comments.all %}
      <div class="border rounded p-3 mb-2">
        <strong>{{ comment.author.username }}</strong>
        <small class="text-muted">â€¢ {{ comment.created_at|date:"d.m.Y H:i" }}</small>
        <p class="mb-0">{{ comment.text }}</p>
      </div>
    {% empty %}
      <p class="text-muted">ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸ĞµĞ² Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚.</p>
    {% endfor %}
  </div>

  <!-- Ğ¤Ğ¾Ñ€Ğ¼Ğ° ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ñ -->
  {% if user.is_authenticated %}
    <div class="mt-4">
      <h6>Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹</h6>
      <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" class="btn btn-primary">ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ</button>
      </form>
    </div>
  {% else %}
    <p class="mt-4">Ğ§Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹, <a href="{% url 'login' %}">Ğ²Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ Ğ² Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚</a>.</p>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.getElementById('like-button').addEventListener('click', function () {
    fetch("{% url 'like_post' post.slug %}", {
      method: "POST",
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'X-Requested-With': 'XMLHttpRequest',
      },
    })
    .then(res => res.json())
    .then(data => {
      if (data) {
        document.getElementById('like-count').textContent = data.likes_count;
        document.getElementById('like-icon').innerHTML = data.liked ? 'ğŸ‘' : '<span style="color: white;">ğŸ‘</span>';
        document.getElementById('dislike-icon').innerHTML = '<span style="color: white;">ğŸ‘</span>';
      }
    });
  });

  document.getElementById('dislike-button').addEventListener('click', function () {
    fetch("{% url 'dislike_post' post.slug %}", {
      method: "POST",
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'X-Requested-With': 'XMLHttpRequest',
      },
    })
    .then(res => res.json())
    .then(data => {
      if (data) {
        document.getElementById('dislike-count').textContent = data.dislikes_count;
        document.getElementById('dislike-icon').innerHTML = data.disliked ? 'ğŸ‘' : '<span style="color: white;">ğŸ‘</span>';
        document.getElementById('like-icon').innerHTML = '<span style="color: white;">ğŸ‘</span>';
      }
    });
  });
</script>
{% endblock %}
